<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Simple Nested Task Planner</title>
    <style>
        body { font-family: -apple-system, Arial, sans-serif; margin: 0; padding: 10px; background: #1c1c1e; color: #fff; }
        #projects { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 20px; }
        .project { flex: 0 0 auto; width: 300px; background: #2c2c2e; border-radius: 10px; padding: 10px; min-height: 200px; position: relative; }
        .project-header { display: flex; justify-content: space-between; align-items: center; }
        .project h2 { font-size: 18px; margin: 0; cursor: text; flex: 1; }
        .project h2[contenteditable]:focus { outline: none; background: #3c3c3e; }
        ul { list-style: none; padding-left: 0; }
        li { margin: 8px 0; position: relative; }
        .task { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 5px; position: relative; }
        .task::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: var(--sibling-color); }
        .task input[type="checkbox"] { margin: 0 5px 0 0; width: 20px; height: 20px; }
        .task span { flex: 1; min-height: 20px; }
        .task.completed span { text-decoration: line-through; color: #888; }
        .collapse-arrow { margin: 0 5px 0 0; font-size: 14px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; margin-left: 5px; font-size: 12px; }
        .delete-btn:hover { background: #c0392b; }
        .add-btn { background: #4285F4; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-bottom: 10px; margin-right: 5px; }
        .add-btn:hover { background: #357AE8; }
        .add-category-btn { background: #2ecc71; color: white; }
        .add-category-btn:hover { background: #27ae60; }
        .subtasks { padding-left: 20px; display: none; }
        .expanded .subtasks { display: block; }
        .draggable { cursor: move; touch-action: manipulation; }
        .move-buttons { display: flex; }
        .move-left, .move-right { background: #555; color: white; border: none; cursor: pointer; padding: 5px; margin-left: 5px; }
        /* 10-level color theme */
        .level-0 .task { background: #3c3c3e; }
        .level-1 .task { background: #4a4a4a; }
        .level-2 .task { background: #585858; }
        .level-3 .task { background: #666666; }
        .level-4 .task { background: #747474; }
        .level-5 .task { background: #828282; }
        .level-6 .task { background: #909090; }
        .level-7 .task { background: #9e9e9e; }
        .level-8 .task { background: #acacac; }
        .level-9 .task { background: #bababa; }
        /* Checkbox colors matching levels */
        .level-0 input[type="checkbox"] { accent-color: #3c3c3e; }
        .level-1 input[type="checkbox"] { accent-color: #4a4a4a; }
        .level-2 input[type="checkbox"] { accent-color: #585858; }
        .level-3 input[type="checkbox"] { accent-color: #666666; }
        .level-4 input[type="checkbox"] { accent-color: #747474; }
        .level-5 input[type="checkbox"] { accent-color: #828282; }
        .level-6 input[type="checkbox"] { accent-color: #909090; }
        .level-7 input[type="checkbox"] { accent-color: #9e9e9e; }
        .level-8 input[type="checkbox"] { accent-color: #acacac; }
        .level-9 input[type="checkbox"] { accent-color: #bababa; }
        /* Sibling colors (10 distinct colors) */
        .sibling-0 { --sibling-color: #ff0000; }
        .sibling-1 { --sibling-color: #ff7f00; }
        .sibling-2 { --sibling-color: #ffff00; }
        .sibling-3 { --sibling-color: #7fff00; }
        .sibling-4 { --sibling-color: #00ff00; }
        .sibling-5 { --sibling-color: #00ff7f; }
        .sibling-6 { --sibling-color: #00ffff; }
        .sibling-7 { --sibling-color: #007fff; }
        .sibling-8 { --sibling-color: #0000ff; }
        .sibling-9 { --sibling-color: #7f00ff; }
        /* Light mode adjustments */
        @media (prefers-color-scheme: light) {
            body { background: #fff; color: #000; }
            .project { background: #f9f9f9; }
            .level-0 .task { background: #e9e9e9; }
            .level-1 .task { background: #dcdcdc; }
            .level-2 .task { background: #cfcfcf; }
            .level-3 .task { background: #c2c2c2; }
            .level-4 .task { background: #b5b5b5; }
            .level-5 .task { background: #a8a8a8; }
            .level-6 .task { background: #9b9b9b; }
            .level-7 .task { background: #8e8e8e; }
            .level-8 .task { background: #818181; }
            .level-9 .task { background: #747474; }
            .delete-btn { background: #e74c3c; }
            .delete-btn:hover { background: #c0392b; }
            .level-0 input[type="checkbox"] { accent-color: #e9e9e9; }
            .level-1 input[type="checkbox"] { accent-color: #dcdcdc; }
            .level-2 input[type="checkbox"] { accent-color: #cfcfcf; }
            .level-3 input[type="checkbox"] { accent-color: #c2c2c2; }
            .level-4 input[type="checkbox"] { accent-color: #b5b5b5; }
            .level-5 input[type="checkbox"] { accent-color: #a8a8a8; }
            .level-6 input[type="checkbox"] { accent-color: #9b9b9b; }
            .level-7 input[type="checkbox"] { accent-color: #8e8e8e; }
            .level-8 input[type="checkbox"] { accent-color: #818181; }
            .level-9 input[type="checkbox"] { accent-color: #747474; }
        }
        @media (max-width: 600px) { .project { width: 100%; } #projects { flex-direction: column; } .move-left, .move-right { display: none; } }
        #history-buttons { margin-bottom: 10px; }
        #undo-btn, #redo-btn { background: #555; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        #undo-btn:hover, #redo-btn:hover { background: #666; }
    </style>
</head>
<body>
    <h1 style="font-size: 24px; margin-bottom: 10px;">Task Planner</h1>
    <div id="history-buttons">
        <button id="undo-btn" onclick="undo()">Undo</button>
        <button id="redo-btn" onclick="redo()">Redo</button>
    </div>
    <button class="add-btn" onclick="addProject()">+ Add Projects</button>
    <div id="projects"></div>

    <script>
        const projectsContainer = document.getElementById('projects');
        let history = [];
        let historyIndex = -1;

        function saveState() {
            const currentState = projectsContainer.innerHTML;
            history = history.slice(0, historyIndex + 1);
            history.push(currentState);
            historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                projectsContainer.innerHTML = history[historyIndex];
                reattachEvents();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                projectsContainer.innerHTML = history[historyIndex];
                reattachEvents();
            }
        }

        function createProject(name = 'New Project') {
            const projectDiv = document.createElement('div');
            projectDiv.classList.add('project', 'draggable');
            projectDiv.draggable = true;

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('project-header');

            const header = document.createElement('h2');
            header.contentEditable = true;
            header.textContent = name;
            header.onblur = () => saveProjects(true);

            const moveButtons = document.createElement('div');
            moveButtons.classList.add('move-buttons');

            const moveLeftBtn = document.createElement('button');
            moveLeftBtn.classList.add('move-left');
            moveLeftBtn.textContent = '←';
            moveLeftBtn.onclick = () => moveProject(projectDiv, -1);

            const moveRightBtn = document.createElement('button');
            moveRightBtn.classList.add('move-right');
            moveRightBtn.textContent = '→';
            moveRightBtn.onclick = () => moveProject(projectDiv, 1);

            moveButtons.appendChild(moveLeftBtn);
            moveButtons.appendChild(moveRightBtn);

            const deleteProjectBtn = document.createElement('button');
            deleteProjectBtn.classList.add('delete-btn');
            deleteProjectBtn.textContent = '×';
            deleteProjectBtn.onclick = () => deleteElement(projectDiv);

            headerDiv.appendChild(header);
            headerDiv.appendChild(moveButtons);
            headerDiv.appendChild(deleteProjectBtn);

            const addTaskBtn = document.createElement('button');
            addTaskBtn.classList.add('add-btn');
            addTaskBtn.textContent = '+ T';
            addTaskBtn.title = 'Add Task';
            addTaskBtn.onclick = () => addTaskTo(projectDiv, null, false, false);

            const addCategoryBtn = document.createElement('button');
            addCategoryBtn.classList.add('add-btn', 'add-category-btn');
            addCategoryBtn.textContent = '+ C';
            addCategoryBtn.title = 'Add Category';
            addCategoryBtn.onclick = () => addTaskTo(projectDiv, null, false, true);

            const taskList = document.createElement('ul');
            taskList.classList.add('taskList', 'level-0');

            projectDiv.appendChild(headerDiv);
            projectDiv.appendChild(addTaskBtn);
            projectDiv.appendChild(addCategoryBtn);
            projectDiv.appendChild(taskList);
            return projectDiv;
        }

        function addProject() {
            const name = prompt('Enter project name:', 'New Project');
            if (name) {
                const newProject = createProject(name);
                projectsContainer.appendChild(newProject);
                saveProjects(true);
            }
        }

        function createTask(text = 'New Task', isCategory = false) {
            const li = document.createElement('li');
            li.classList.add('draggable');
            li.draggable = true;

            const taskDiv = document.createElement('div');
            taskDiv.classList.add('task');

            const arrow = document.createElement('span');
            arrow.classList.add('collapse-arrow');
            arrow.textContent = '▶';
            arrow.onclick = toggleCollapse;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.onchange = toggleComplete;
            if (isCategory) checkbox.style.display = 'none';

            const span = document.createElement('span');
            span.contentEditable = true;
            span.textContent = text;
            span.onkeydown = handleEnter;
            span.onclick = () => {
                if (span.textContent === 'New Task' || span.textContent === 'New Subtask' || span.textContent === 'New Category') {
                    span.textContent = '';
                }
                const range = document.createRange();
                range.selectNodeContents(span);
                range.collapse(true);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            };

            const addTaskBtn = document.createElement('button');
            addTaskBtn.classList.add('add-btn');
            addTaskBtn.textContent = '+ T';
            addTaskBtn.title = 'Add Task';
            addTaskBtn.onclick = () => addTaskTo(li.parentElement.parentElement, li, true, false);

            const addCategoryBtn = document.createElement('button');
            addCategoryBtn.classList.add('add-btn', 'add-category-btn');
            addCategoryBtn.textContent = '+ C';
            addCategoryBtn.title = 'Add Category';
            addCategoryBtn.onclick = () => addTaskTo(li.parentElement.parentElement, li, true, true);

            const deleteTaskBtn = document.createElement('button');
            deleteTaskBtn.classList.add('delete-btn');
            deleteTaskBtn.textContent = '×';
            deleteTaskBtn.onclick = () => deleteElement(li);

            taskDiv.appendChild(arrow);
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(span);
            taskDiv.appendChild(addTaskBtn);
            taskDiv.appendChild(addCategoryBtn);
            taskDiv.appendChild(deleteTaskBtn);

            const subtasksUl = document.createElement('ul');
            subtasksUl.classList.add('subtasks');

            li.appendChild(taskDiv);
            li.appendChild(subtasksUl);
            return li;
        }

        function addTaskTo(projectDiv, parentLi = null, isSubtask = false, isCategory = false) {
            const taskList = isSubtask ? parentLi.querySelector('.subtasks') : projectDiv.querySelector('.taskList');
            const newTask = createTask(isSubtask ? 'New Subtask' : (isCategory ? 'New Category' : 'New Task'), isCategory);
            taskList.appendChild(newTask);
            updateArrowVisibility(newTask);
            const nestingLevel = getNestingLevel(taskList) + 1;
            newTask.querySelector('.subtasks').classList.add(`level-${nestingLevel % 10}`);
            if (isSubtask) {
                parentLi.classList.add('expanded');
                parentLi.querySelector('.collapse-arrow').textContent = '▼';
            }
            updateSiblingColors(taskList);
            saveProjects(true);
        }

        function updateSiblingColors(list) {
            const siblings = Array.from(list.children);
            siblings.forEach((sibling, index) => {
                sibling.classList.remove(...Array.from({length: 10}, (_, i) => `sibling-${i}`));
                sibling.classList.add(`sibling-${index % 10}`);
                const subList = sibling.querySelector('.subtasks');
                if (subList) updateSiblingColors(subList);
            });
        }

        function getNestingLevel(element) {
            let level = 0;
            while (element && !element.classList.contains('project')) {
                if (element.classList.contains('subtasks')) level++;
                element = element.parentElement;
            }
            return level;
        }

        function toggleCollapse(e) {
            e.stopPropagation();
            const li = this.parentElement.parentElement;
            li.classList.toggle('expanded');
            this.textContent = li.classList.contains('expanded') ? '▼' : '▶';
            saveProjects(true);
        }

        function toggleComplete() {
            const taskDiv = this.parentElement;
            taskDiv.classList.toggle('completed', this.checked);
            const li = taskDiv.parentElement;
            const list = li.parentElement;
            if (this.checked) {
                list.appendChild(li);
            }
            updateSiblingColors(list);
            saveProjects(true);
        }

        function handleEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const li = this.parentElement.parentElement;
                const isSub = li.parentElement.classList.contains('subtasks');
                const projectDiv = getProjectDiv(li);
                addTaskTo(projectDiv, isSub ? li.parentElement.parentElement : null, isSub, false);
                const newSpan = li.nextSibling ? li.nextSibling.querySelector('span') : li.parentElement.lastChild.querySelector('span');
                newSpan.focus();
            }
        }

        function getProjectDiv(element) {
            while (element && !element.classList.contains('project')) {
                element = element.parentElement;
            }
            return element;
        }

        function saveProjects(saveToHistory = false) {
            const projectsData = Array.from(projectsContainer.children).map(project => ({
                name: project.querySelector('h2').textContent,
                tasks: project.querySelector('.taskList').innerHTML
            }));
            localStorage.setItem('projects', JSON.stringify(projectsData));
            if (saveToHistory) saveState();
        }

        function loadProjects() {
            const saved = localStorage.getItem('projects');
            if (saved) {
                const projectsData = JSON.parse(saved);
                projectsData.forEach(data => {
                    const newProject = createProject(data.name);
                    newProject.querySelector('.taskList').innerHTML = data.tasks;
                    projectsContainer.appendChild(newProject);
                    newProject.querySelectorAll('.collapse-arrow').forEach(arrow => {
                        const li = arrow.parentElement.parentElement;
                        arrow.onclick = toggleCollapse;
                        updateArrowVisibility(li);
                    });
                    newProject.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onchange = toggleComplete);
                    newProject.querySelectorAll('span[contenteditable]').forEach(span => {
                        span.onkeydown = handleEnter;
                        span.onclick = () => {
                            if (span.textContent === 'New Task' || span.textContent === 'New Subtask' || span.textContent === 'New Category') {
                                span.textContent = '';
                            }
                            const range = document.createRange();
                            range.selectNodeContents(span);
                            range.collapse(true);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        };
                    });
                    newProject.querySelectorAll('.add-btn').forEach(btn => {
                        if (btn.textContent === '+ T') btn.onclick = () => addTaskTo(newProject, null, false, false);
                        else if (btn.textContent === '+ C') btn.onclick = () => addTaskTo(newProject, null, false, true);
                        else btn.onclick = (e) => {
                            const li = e.target.closest('li');
                            addTaskTo(newProject, li, true, false);
                        };
                    });
                    newProject.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const element = e.target.closest('li') || e.target.closest('.project');
                            deleteElement(element);
                        };
                    });
                    newProject.querySelectorAll('.subtasks').forEach(ul => {
                        const level = getNestingLevel(ul) % 10;
                        ul.classList.add(`level-${level}`);
                    });
                    newProject.querySelector('.move-left').onclick = () => moveProject(newProject, -1);
                    newProject.querySelector('.move-right').onclick = () => moveProject(newProject, 1);
                    newProject.querySelectorAll('.taskList, .subtasks').forEach(ul => updateSiblingColors(ul));
                });
            }
            saveState(); // Initial state
        }

        function deleteElement(element) {
            element.remove();
            saveProjects(true);
        }

        function updateArrowVisibility(li) {
            const arrow = li.querySelector('.collapse-arrow');
            const subtasks = li.querySelector('.subtasks');
            if (subtasks && subtasks.children.length > 0) {
                arrow.style.display = 'inline';
            } else {
                arrow.style.display = 'none';
                li.classList.remove('expanded');
            }
        }

        function moveProject(project, direction) {
            const projects = Array.from(projectsContainer.children);
            const index = projects.indexOf(project);
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < projects.length) {
                projectsContainer.insertBefore(project, direction > 0 ? projects[newIndex + 1] : projects[newIndex]);
                saveProjects(true);
            }
        }

        function setupDragAndDrop(container) {
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('draggable')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', '');
                }
            });
            container.addEventListener('dragover', e => e.preventDefault());
            container.addEventListener('drop', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    const afterElement = getDragAfterElement(container, e.clientX || e.touches?.[0].clientX);
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                    dragging.classList.remove('dragging');
                    Array.from(container.querySelectorAll('li')).forEach(li => updateArrowVisibility(li));
                    updateSiblingColors(container);
                    saveProjects(true);
                }
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function reattachEvents() {
            document.querySelectorAll('.project').forEach(project => {
                project.querySelectorAll('.collapse-arrow').forEach(arrow => {
                    const li = arrow.parentElement.parentElement;
                    arrow.onclick = toggleCollapse;
                    updateArrowVisibility(li);
                });
                project.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onchange = toggleComplete);
                project.querySelectorAll('span[contenteditable]').forEach(span => {
                    span.onkeydown = handleEnter;
                    span.onclick = () => {
                        if (span.textContent === 'New Task' || span.textContent === 'New Subtask' || span.textContent === 'New Category') {
                            span.textContent = '';
                        }
                        const range = document.createRange();
                        range.selectNodeContents(span);
                        range.collapse(true);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    };
                });
                project.querySelectorAll('.add-btn').forEach(btn => {
                    if (btn.textContent === '+ T') btn.onclick = () => addTaskTo(project, null, false, false);
                    else if (btn.textContent === '+ C') btn.onclick = () => addTaskTo(project, null, false, true);
                    else btn.onclick = (e) => {
                        const li = e.target.closest('li');
                        addTaskTo(project, li, true, false);
                    };
                });
                project.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const element = e.target.closest('li') || e.target.closest('.project');
                        deleteElement(element);
                    };
                });
                project.querySelector('.move-left').onclick = () => moveProject(project, -1);
                project.querySelector('.move-right').onclick = () => moveProject(project, 1);
            });
            document.querySelectorAll('.taskList, .subtasks').forEach(ul => {
                setupDragAndDrop(ul);
                updateSiblingColors(ul);
            });
            setupDragAndDrop(projectsContainer);
        }

        loadProjects();
    </script>
</body>
</html>
