<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Simple Nested Task Planner</title>
    <style>
        body { font-family: -apple-system, Arial, sans-serif; margin: 0; padding: 10px; background: #1c1c1e; color: #fff; }
        #projects { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 20px; }
        .project { flex: 0 0 auto; width: 300px; background: #2c2c2e; border-radius: 10px; padding: 10px; min-height: 200px; position: relative; }
        .project h2 { font-size: 18px; margin: 0 0 10px; cursor: text; }
        .project h2[contenteditable]:focus { outline: none; background: #3c3c3e; }
        ul { list-style: none; padding-left: 0; }
        li { margin: 8px 0; position: relative; }
        .task { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 5px; }
        .task input[type="checkbox"] { margin: 0 5px 0 0; width: 20px; height: 20px; }
        .task span { flex: 1; min-height: 20px; }
        .task.completed span { text-decoration: line-through; color: #888; }
        .collapse-arrow { margin: 0 5px 0 0; font-size: 14px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; margin-left: 5px; font-size: 12px; }
        .delete-btn:hover { background: #c0392b; }
        .add-btn { background: #4285F4; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-bottom: 10px; margin-right: 5px; }
        .add-btn:hover { background: #357AE8; }
        .subtasks { padding-left: 20px; display: none; }
        .expanded .subtasks { display: block; }
        .draggable { cursor: move; touch-action: manipulation; }
        .move-left, .move-right { position: absolute; top: 5px; background: #555; color: white; border: none; cursor: pointer; padding: 5px; }
        .move-left { left: -15px; }
        .move-right { right: -15px; }
        /* Nesting colors */
        .level-0 .task { background: #3c3c3e; }
        .level-1 .task { background: #4c4c4e; }
        .level-2 .task { background: #5c5c5e; }
        .level-3 .task { background: #6c6c6e; }
        .level-4 .task { background: #7c7c7e; }
        /* Light mode adjustments */
        @media (prefers-color-scheme: light) {
            body { background: #fff; color: #000; }
            .project { background: #f9f9f9; }
            .level-0 .task { background: #e9e9e9; }
            .level-1 .task { background: #d9d9d9; }
            .level-2 .task { background: #c9c9c9; }
            .level-3 .task { background: #b9b9b9; }
            .level-4 .task { background: #a9a9a9; }
            .delete-btn { background: #e74c3c; }
            .delete-btn:hover { background: #c0392b; }
        }
        @media (max-width: 600px) { .project { width: 100%; } #projects { flex-direction: column; } .move-left, .move-right { display: none; } }
    </style>
</head>
<body>
    <h1 style="font-size: 24px; margin-bottom: 10px;">Task Planner</h1>
    <button class="add-btn" onclick="addProject()">+ Add Projects</button>
    <div id="projects"></div>

    <script>
        const projectsContainer = document.getElementById('projects');

        function createProject(name = 'New Project') {
            const projectDiv = document.createElement('div');
            projectDiv.classList.add('project', 'draggable');
            projectDiv.draggable = true;

            const header = document.createElement('h2');
            header.contentEditable = true;
            header.textContent = name;
            header.onblur = saveProjects;

            const addTaskBtn = document.createElement('button');
            addTaskBtn.classList.add('add-btn');
            addTaskBtn.textContent = '+ Add Task';
            addTaskBtn.onclick = () => addTaskTo(projectDiv, null, false, false);

            const addCategoryBtn = document.createElement('button');
            addCategoryBtn.classList.add('add-btn');
            addCategoryBtn.textContent = '+ Add Category';
            addCategoryBtn.onclick = () => addTaskTo(projectDiv, null, false, true);

            const deleteProjectBtn = document.createElement('button');
            deleteProjectBtn.classList.add('delete-btn');
            deleteProjectBtn.textContent = '×';
            deleteProjectBtn.onclick = () => deleteElement(projectDiv);

            const moveLeftBtn = document.createElement('button');
            moveLeftBtn.classList.add('move-left');
            moveLeftBtn.textContent = '←';
            moveLeftBtn.onclick = () => moveProject(projectDiv, -1);

            const moveRightBtn = document.createElement('button');
            moveRightBtn.classList.add('move-right');
            moveRightBtn.textContent = '→';
            moveRightBtn.onclick = () => moveProject(projectDiv, 1);

            const taskList = document.createElement('ul');
            taskList.classList.add('taskList', 'level-0');

            projectDiv.appendChild(header);
            projectDiv.appendChild(addTaskBtn);
            projectDiv.appendChild(addCategoryBtn);
            projectDiv.appendChild(deleteProjectBtn);
            projectDiv.appendChild(moveLeftBtn);
            projectDiv.appendChild(moveRightBtn);
            projectDiv.appendChild(taskList);
            return projectDiv;
        }

        function addProject() {
            const name = prompt('Enter project name:', 'New Project');
            if (name) {
                const newProject = createProject(name);
                projectsContainer.appendChild(newProject);
                saveProjects();
            }
        }

        function createTask(text = 'New Task', isCategory = false) {
            const li = document.createElement('li');
            li.classList.add('draggable');
            li.draggable = true;

            const taskDiv = document.createElement('div');
            taskDiv.classList.add('task');

            const arrow = document.createElement('span');
            arrow.classList.add('collapse-arrow');
            arrow.textContent = '▶';
            arrow.onclick = toggleCollapse;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.onchange = toggleComplete;
            if (isCategory) checkbox.style.display = 'none';

            const span = document.createElement('span');
            span.contentEditable = true;
            span.textContent = text;
            span.onkeydown = handleEnter;

            const addSubBtn = document.createElement('button');
            addSubBtn.classList.add('add-btn');
            addSubBtn.textContent = '+ Sub';
            addSubBtn.onclick = () => addTaskTo(li.parentElement.parentElement, li, true, false);

            const deleteTaskBtn = document.createElement('button');
            deleteTaskBtn.classList.add('delete-btn');
            deleteTaskBtn.textContent = '×';
            deleteTaskBtn.onclick = () => deleteElement(li);

            taskDiv.appendChild(arrow);
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(span);
            taskDiv.appendChild(addSubBtn);
            taskDiv.appendChild(deleteTaskBtn);

            const subtasksUl = document.createElement('ul');
            subtasksUl.classList.add('subtasks');

            li.appendChild(taskDiv);
            li.appendChild(subtasksUl);
            return li;
        }

        function addTaskTo(projectDiv, parentLi = null, isSubtask = false, isCategory = false) {
            const taskList = isSubtask ? parentLi.querySelector('.subtasks') : projectDiv.querySelector('.taskList');
            const newTask = createTask(isSubtask ? 'New Subtask' : 'New Task', isCategory);
            taskList.appendChild(newTask);
            updateArrowVisibility(newTask);
            const nestingLevel = getNestingLevel(taskList) + 1;
            newTask.querySelector('.subtasks').classList.add(`level-${nestingLevel}`);
            if (isSubtask) {
                parentLi.classList.add('expanded');
                parentLi.querySelector('.collapse-arrow').textContent = '▼';
            }
            saveProjects();
        }

        function getNestingLevel(element) {
            let level = 0;
            while (element && !element.classList.contains('project')) {
                if (element.classList.contains('subtasks')) level++;
                element = element.parentElement;
            }
            return level;
        }

        function toggleCollapse(e) {
            e.stopPropagation();
            const li = this.parentElement.parentElement;
            li.classList.toggle('expanded');
            this.textContent = li.classList.contains('expanded') ? '▼' : '▶';
            saveProjects();
        }

        function toggleComplete() {
            const taskDiv = this.parentElement;
            taskDiv.classList.toggle('completed', this.checked);
            const li = taskDiv.parentElement;
            const list = li.parentElement;
            if (this.checked) {
                list.appendChild(li); // Move to bottom
            }
            saveProjects();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const li = this.parentElement.parentElement;
                const isSub = li.parentElement.classList.contains('subtasks');
                const projectDiv = getProjectDiv(li);
                addTaskTo(projectDiv, isSub ? li.parentElement.parentElement : null, isSub, false);
                const newSpan = li.nextSibling ? li.nextSibling.querySelector('span') : li.parentElement.lastChild.querySelector('span');
                newSpan.focus();
            }
        }

        function getProjectDiv(element) {
            while (element && !element.classList.contains('project')) {
                element = element.parentElement;
            }
            return element;
        }

        function saveProjects() {
            const projectsData = Array.from(projectsContainer.children).map(project => ({
                name: project.querySelector('h2').textContent,
                tasks: project.querySelector('.taskList').innerHTML
            }));
            localStorage.setItem('projects', JSON.stringify(projectsData));
        }

        function loadProjects() {
            const saved = localStorage.getItem('projects');
            if (saved) {
                const projectsData = JSON.parse(saved);
                projectsData.forEach(data => {
                    const newProject = createProject(data.name);
                    newProject.querySelector('.taskList').innerHTML = data.tasks;
                    projectsContainer.appendChild(newProject);
                    newProject.querySelectorAll('.collapse-arrow').forEach(arrow => {
                        const li = arrow.parentElement.parentElement;
                        arrow.onclick = toggleCollapse;
                        updateArrowVisibility(li);
                    });
                    newProject.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onchange = toggleComplete);
                    newProject.querySelectorAll('span[contenteditable]').forEach(span => span.onkeydown = handleEnter);
                    newProject.querySelectorAll('.add-btn').forEach(btn => {
                        if (btn.textContent === '+ Add Task') btn.onclick = () => addTaskTo(newProject, null, false, false);
                        else if (btn.textContent === '+ Add Category') btn.onclick = () => addTaskTo(newProject, null, false, true);
                        else btn.onclick = (e) => {
                            const li = e.target.closest('li');
                            addTaskTo(newProject, li, true, false);
                        };
                    });
                    newProject.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const element = e.target.closest('li') || e.target.closest('.project');
                            deleteElement(element);
                        };
                    });
                    newProject.querySelectorAll('.subtasks').forEach(ul => {
                        const level = getNestingLevel(ul);
                        ul.classList.add(`level-${level}`);
                    });
                    newProject.querySelector('.move-left').onclick = () => moveProject(newProject, -1);
                    newProject.querySelector('.move-right').onclick = () => moveProject(newProject, 1);
                });
            }
        }

        function deleteElement(element) {
            if (element.classList.contains('project')) {
                element.remove();
            } else if (element.classList.contains('draggable')) {
                element.remove();
            }
            saveProjects();
        }

        function updateArrowVisibility(li) {
            const arrow = li.querySelector('.collapse-arrow');
            const subtasks = li.querySelector('.subtasks');
            if (subtasks && subtasks.children.length > 0) {
                arrow.style.display = 'inline';
            } else {
                arrow.style.display = 'none';
                li.classList.remove('expanded');
            }
        }

        function moveProject(project, direction) {
            const projects = Array.from(projectsContainer.children);
            const index = projects.indexOf(project);
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < projects.length) {
                projectsContainer.insertBefore(project, direction > 0 ? projects[newIndex + 1] : projects[newIndex]);
                saveProjects();
            }
        }

        function setupDragAndDrop(container) {
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('draggable')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', '');
                }
            });
            container.addEventListener('dragover', e => e.preventDefault());
            container.addEventListener('drop', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    const afterElement = getDragAfterElement(container, e.clientX || e.touches?.[0].clientX);
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                    dragging.classList.remove('dragging');
                    Array.from(container.querySelectorAll('li')).forEach(li => updateArrowVisibility(li));
                    saveProjects();
                }
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        loadProjects();
        setupDragAndDrop(projectsContainer);
        document.querySelectorAll('.taskList, .subtasks').forEach(ul => setupDragAndDrop(ul));
    </script>
</body>
</html>
